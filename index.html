<!doctype html>
<html>
  <head>
  <style>
  table{
    table-layout:fixed;
	}
  th{
    word-wrap:break-word;
    }
  td{
    white-space:nowrap;
    }
  </style>
    <title>Israel Tax Calculator (Annual) 2018</title>
  </head>
  <body>
  <script type="text/javascript">
    // basic tax constants
    const taxBrackets = [[0, 0.1, 0],
                  [75720.0, 0.14, 7572],
                  [108600.0, 0.2, 12175.2],
                  [174360.0, 0.31, 25327.2],
                  [242400.0, 0.35, 46419.6],
                  [504360.0, 0.47, 138105.6],
                  [649560.0, 0.5, 206349.6]]; 
                  // each bracket: [bottom of bracket NIS, tax rate, cumulative tax paid in lower brackets (floor) NIS]
    // tax credit constants
    const taxCreditValue = 218; // NIS
    // charitable donations constants
    const maxCharityProportionOfGross = 0.3 // only charitable contributions under 30% of annual income are eligible
    const charityReliefRate = 0.35 // get income tax reduction of 35% of contributions
    const minEligibleDonation = 190 // NIS. Total charitable donations must exceed 190NIS to be eligible for relief
    // pension-related constants
    const hachnasaMezaka = 105600 // NIS
    const maxPensionContributionsRate = 0.07 // 7% of insured income
    const pensionReliefRate = 0.35 // get income tax reduction of 35% of contributions
   
   	function sumElements(collection) {
          sum = 0;
          for (let item of collection) {
          	if (!isNaN(parseFloat(item.value))) {
              sum += parseFloat(item.value);
              }
          }
          return sum;
		}
    function calculateTaxBrackets(gross, taxBrackets) {
          i = 0;
          while ((i < taxBrackets.length) && (gross > taxBrackets[i][0])) {
                i++;
              }
          bracket = taxBrackets[i-1];
          tax = bracket[2] + bracket[1]*(gross - bracket[0]);
          return tax;
		}
    </script>
    <h1>Israel Tax Calculator (Annual) 2018</h2>
    <form id="annual-tax" onsubmit="return false;">
    <h2>Salary and pension overview</h2>
    <div>
    <table>
    <!-- Add feature: press a (+) button to add more employers -->
      <tr>
        <th>Employer name</th>
        <th>Taxable income (158)</th> 
    	<th>Income Tax Paid (042)</th>
        <th>Employee pension deposits (045)</th>
        <th>Employer pension deposits + <i>Pitsuyim</i> (248)</th>
        <th>Insured Income (244)</th>
      </tr>
      <tr>
        <td><input type="text" id="employerName1" value="Employer 1"/></td> 
        <td ><input type="number" class="gross" id="gross1" min="0" max="10000000" step="0.01"/>&#8362</td> 
        <td><input type="number" class="taxPaid" id="taxPaid1" min= "0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="employeePension" id="employeePension1 "min="0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="employerPension" id="employerPension1" min="0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="insuredIncome" id="insuredIncome1" min="0" max="10000000" step="0.01"/>&#8362</td>
      </tr>
      <tr>
        <td><input type="text" id="employerName2" value="Employer 2"/></td>
        <td><input type="number" class="gross" id="gross2" min="0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="taxPaid" id="taxPaid2" min="0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="employeePension" id="employeePension2" min="0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="employerPension" id="employerPension2" min="0" max="10000000" step="0.01"/>&#8362</td>
        <td><input type="number" class="insuredIncome" id="insuredIncome2" min="0" max="10000000" step="0.01"/>&#8362</td>
      </tr>
    </table>
    </div>
    <div>
    <br><br>
    <b>Optional independent pension contributions (135 or 268):</b>
        <input id="units" step="any" type="number" /> &#8362
    </div>
    <br>
      <h2>Tax credits (<i>Nekudot Zikui</i>)</h2>
    <div>
    <table>
      <tr>
        <th></th>
        <th width=100px>Number of tax credits (monthly)</th> 
        <!-- Add option to set one number for all months -->
        <!-- Maybe convert to dropdown menu -->
      </tr>
      <tr>
        <td>Jan</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Feb</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Mar</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Apr</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>May</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Jun</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Jul</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Aug</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Sep</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Oct</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Nov</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
            <tr>
        <td>Dec</td>
        <td><input type="number" class="taxCredits" min="0" max="19.75" step="0.25"></td>
      </tr>
    </table>
    </div>
    <div>
    <br>
    Total tax credits: <span id="totalTaxCredits">0.00</span>
    </div>
    <script type="text/javascript">
    var taxCreditsCollection = document.getElementsByClassName('taxCredits');
    for (let elem of taxCreditsCollection) {
            elem.addEventListener("input", function (e) {
            taxCredits = sumElements(taxCreditsCollection);
    document.getElementById('totalTaxCredits').innerHTML = taxCredits; // taxCredits.toFixed(2);
    //const taxCreditValue = 218 // NIS
        
      	try {
                taxCredits = sumElements(document.getElementsByClassName('taxCredits'));
                document.getElementById('totalTaxCredits').innerHTML = taxCredits.toFixed(2);
            }
      	catch(err) {
              document.getElementById("out").innerHTML = err.message;
        			}
        return false;
      	});
      };
      </script>
    <div>
    <br>
    <h2>Charitable Donations</h2>
       <div> Note: total charitable donations must be over 180&#8362; and under MAX_RATE_CHARITABLE of annual income. Only donations to a "<i>Mosad Tsiburi</i>" with receipts are eligible.
       <br><a href="https://www.misim.gov.il/gmtrumot/startPage1.aspx">Search for eligible charities (Hebrew)</a>
       </div>
      <br>
        <table>
    <!-- Add feature: press a (+) button to add more employers -->
      <tr>
        <th>Institution</th>
        <th>Amount (037)</th> 
      </tr>
      <tr>
        <td><input type="text" id="charity1" /></td> 
        <td><input type="number" class="donation" /> &#8362</td>
      </tr>
	  <tr>
        <td><input type="text" id="charity2" /></td> 
        <td><input type="number" class="donation" /> &#8362</td>
      </tr>
      </table>
    <br>
    </div>
    
    <div>
    <input type="submit" value="Calculate tax" />
    </div>
    </form>
    <hr />
    <div style="font-size: 0.8em;">
    Gross income tax before reliefs: <span id="taxBrackets">0.00</span> &#8362;
    </div>
    <div style="font-size: 0.8em;">
    Total tax credit relief: <span id="taxCreditsRelief">0.00</span> &#8362;
    </div>
    <div style="font-size: 0.8em;">
    Charitable donations relief: <span id="charitableDonationsRelief">0.00</span> &#8362;
    </div>
    <div style="font-size: 1.5em;">
    Tax due after reliefs: <span id="out">0.00</span> &#8362;
    </div>
    <script type="text/javascript">
    document.querySelector('#annual-tax').onsubmit = (function(e){
      //  e.preventDefault();
      
      	var gross = sumElements(document.getElementsByClassName('gross'));
        var taxPaid = sumElements(document.getElementsByClassName('taxPaid'));
        var employeePension = sumElements(document.getElementsByClassName('employeePension'));
        var employerPension = sumElements(document.getElementsByClassName('employerPension'));
        var insuredIncome = sumElements(document.getElementsByClassName('insuredIncome'));
        var taxCredits = sumElements(document.getElementsByClassName('taxCredits'));
        var donations = sumElements(document.getElementsByClassName('donation'));
              
        var taxCreditsRelief = taxCredits * taxCreditValue;
		document.getElementById('taxCreditsRelief').innerHTML = taxCreditsRelief.toFixed(2);
		var charitableDonationsRelief = donations * charityReliefRate;
		document.getElementById('charitableDonationsRelief').innerHTML = charitableDonationsRelief.toFixed(2);
        
        try {
          		var taxOwed = calculateTaxBrackets(gross, taxBrackets);
                document.getElementById('taxBrackets').innerHTML = taxOwed.toFixed(2);
            }
      	catch(err) {
              document.getElementById("taxBrackets").innerHTML = err.message;
        			}			
        return false;
    });
    </script>
  </body>
</html>
